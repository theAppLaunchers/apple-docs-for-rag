

- Device Management
- Device Assignment
-  Authenticating with a Device Enrollment Program (DEP) Server 

# Authenticating with a Device Enrollment Program (DEP) Server

Communicate securely with a DEP web service, using a server token.

## Overview

The device enrollment program (DEP) uses a server token to allow a Mobile Device Management (MDM) server to securely communicate with a DEP web service.

### Get a DEP Server Token

To get a DEP server token, the user must complete the following steps. The MDM server product can help by automating some of the steps.

1.  Generate a public/private key pair in Privacy Enhanced Mail (PEM) format for the MDM server, and store the private key securely on the server.

2.  Sign into the DEP web portal.

3.  Create a new virtual MDM server.

4.  Upload a PEM-encoded X.509 certificate that contains the public key generated in step 1.

5.  Download the S/MIME-encrypted (Secure/Multipurpose Internet Mail Extensions) token file generated by the program web portal.

6.  Decrypt the S/MIME token.

7.  Upload the token file to the MDM server.

The token consists of these 4 items: the consumer key, the consumer secret, the access token, and the access secret. See Examining Server Tokens for more details.

### Deploy the Server Token

The server tokens can be deployed automatically or manually.

Automatically  
The MDM server must automatically decrypt this file when itâ€™s uploaded to the system, using the private key for the DEP web services.

Manually  
Use the private key and an S/MIME encryption utility to manually decrypt the encrypted token file before it is uploaded to the MDM server. The MDM server then uses the plain-text token file for authentication with the DEP services.

### Use the OAuth Credentials

Each service request to the MDM enrollment service must include an `X-ADM-Auth-Session` header. If the request does not have a valid `X-ADM-Auth-Session` header, or the auth token has expired, the server returns an `HTTP 401 Unauthorized` error. A new `X-ADM-Auth-Session` can be requested by using the `https://mdmenrollment.apple.com/session` endpoint. This endpoint supports the OAuth 1.0a protocol for accessing protected resources.

OAuth requests must provide the server-token fields along with a timestamp (in seconds since January 1, 1970 00:00:00 GMT) and a cryptographically random nonce that must be unique for all requests made with a given timestamp. Sign the request using HMAC-SHA1, as described in http://oauth.net/core/1.0a/#signing_process. A request might look like:

```
```

Note

Multiline headers are deprectated in RFC7230, though are presented above on multiple lines for readability. Your app should use a single line for its request.

The token service validates the request and replies with a JSON payload containing a single key, `auth_session_token`, that contains the new `X-ADM-Auth-Session` token. A sample response might look like:

```
```

After a period of time, the token expires and the service returns a `401` error code. When this happens, the MDM server must request a new session token.

Note

The Device Enrollment Program service periodically issues a new `X-ADM-Auth-Session` in its response to other service calls. The MDM server should use this new header value in subsequent calls.

## Topics

### Examples and Error Codes

Examining Server Tokens

View sample encrypted and unencrypted tokens to verify your server tokens are in the right format.

Interpreting Error Codes

Interpret the error codes you might encounter or that can happen during authentication.

## See Also

### Authentication

Authenticating Through Web Views

Use your own custom web interfaces to authenticate users.

